<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Experiment (jsPsych v8)</title>
  <link href="static/css/style.css" rel="stylesheet" type="text/css">
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
  <script src="https://unpkg.com/jspsych@8.2.1"></script>

  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-categorize-html@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="static/lib/underscore-min.js"></script>
  <script src="static/lib/papaparse.min.js"></script>
  <script src="static/lib/d3.min.js"></script>

  <script src="static/js/initVars.js"></script>
  <script src="static/js/helpers.js"></script>
  <script src="static/js/createTask.js"></script>
  <script src="static/js/createInstructions.js"></script>
  <script src="static/js/saveMailUpload.js"></script>


</head>

<body></body>

<script type="text/javascript">

  let timeline = [];

  // let subjID = Number(jsPsych.data.getURLVariable("id"));
  const urlParams = new URLSearchParams(window.location.search);
  let subjID = Number(urlParams.get("id"));
  let t = new Date();
  let iseq = t.getTime() % 20;
  if (isNaN(subjID)) subjID = iseq;

  let d = new Date();
  let date = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  let start_time = `${d.getHours()}:${d.getMinutes()}`;
  let file_name = `demoRLWM_${subjID}_${date}_${start_time}`;

  let num_tab_switches = 0;
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      if (num_tab_switches >= 3) {
        console.log('Ending exp: too many tab switches');
        setTimeout(() => {
          jsPsych.finishTrial();
          jsPsych.endExperiment('Task ended. Thank you!');
        }, 0);
      } else {
        num_tab_switches++;
        alert(`Please stay on the task page! You left ${num_tab_switches} time(s).`);
      }
    }
  });

  window.addEventListener('beforeunload', function (e) {
    e.preventDefault();
    touch_when_closing(`${file_name}_${num_tab_switches}_switches`);
  });

  // createInstructions();

  Papa.parsePromise(`static/csv/sequence${iseq}.csv`)
          .then(results => createPhase(results))
          .then(task_timeline => {
              window.jsPsych = initJsPsych({ preload_images: IMGS });
              window.jsPsych.run(task_timeline);
          });


</script>


<script>
  console.log(
          "HtmlKb:", typeof jsPsychHtmlKeyboardResponse,
          "CatHtml:", typeof jsPsychCategorizeHtml,
          "ImgKb:",  typeof jsPsychImageKeyboardResponse,
          "Preld:",  typeof jsPsychPreload
  );
</script>
</html>
